title: Combat Test
author: Test Author
version: 1.0

vars:
  skill: 6
  luck: 10
  stamina: 20
  gold: 0
  equip: ["torch", "rope"]

init: |
  msg = ""
  function battle(name, enemy_skill, enemy_stamina)
    local player_attack = d(6) + d(6) + skill
    local enemy_attack = d(6) + d(6) + enemy_skill
    msg = "Your attack roll: "..player_attack.."\nThe "..name.." rolls: "..enemy_attack.."\n\n"
    if player_attack > enemy_attack then
      enemy_stamina = math.max(0, enemy_stamina - 2)
      msg = msg .. "You hit the "..name.." for 2 damage!"
    elseif enemy_attack > player_attack then
      stamina = stamina - 2
      msg = msg .. "The "..name.." hits you for 2 damage!"
    else
      msg = msg .. "It's a tie! No damage dealt."
    end
    return enemy_stamina
  end

  function push_luck()
    local luck_roll = d(6) + d(6)
    local was_lucky = luck_roll < luck
    luck = math.max(0, luck - 1)
    return was_lucky
  end

templates:
  - &fight
    text: "Try to hit the {s.name}"
    if: s.stamina > 0
    run: |
      s.stamina = battle(s.name, s.skill, s.stamina); 
      s.luck_used = false;
    goto: self

  - &push_luck_damage
    text: "Push your luck"
    if: s.stamina > 0 and luck > 0 and string.find(msg, "You hit") ~= nil and not s.luck_used
    run: |
      luck_msg = ""
      if push_luck() then
        s.stamina = math.max(0, s.stamina - 2)
        luck_msg = "You were lucky! You deal an extra 2 points of damage."
      else
        s.stamina = s.stamina + 1
        luck_msg = "You were unlucky! The enemy takes 1 less damage."
      end
      s.luck_used = true;
    notify: "{luck_msg}"
    goto: self

  - &push_luck_avoid
    text: "Push your luck"
    if: luck > 0 and string.find(msg, "hits you") ~= nil and not s.luck_used
    run: |
      luck_msg = ""
      if push_luck() then
        stamina = stamina + 1
        luck_msg = "You were lucky! You avoid 1 points of damage."
      else
        stamina = math.max(0, s.stamina - 1)
        luck_msg = "You were unlucky! You take an extra 1 point of damage."
      end
      s.luck_used = true;
    notify: "{luck_msg}"
    goto: self

sections:
  start:
    title: "The Goblin's Den"
    text: "You are in a dusty cave. A goblin blocks your path."
    options:
      enter:
        text: "Engage the goblin"
        goto: fight

  fight:
    title: "Fight: Ugly Goblin"
    text: "GOBLIN ⎯⎯⎯ Skill: {s.skill} Stamina: {s.stamina}\n\n{msg}"
    vars: { stamina: 7, skill: 6, name: "goblin", luck_used: false }
    options:
      victory:
        text: "Collect your reward"
        if: s.stamina <= 0
        goto: goblin_victory
      fight:
        <<: *fight
      push_luck_damage:
        <<: *push_luck_damage
      push_luck_avoid:
        <<: *push_luck_avoid

  goblin_victory:
    text: "You have defeated the goblin and found a treasure chest!"

  cave_of_shame:
    text: "You fled the battle and retreated to the Cave of Shame. You feel embarrassed."
