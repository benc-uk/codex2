title: The Warlock Of Firetop Mountain
author: Ian Livingstone
version: '1982'

vars:
  skill: 0
  luck: 0
  stamina: 0
  skill_init: 0
  luck_init: 0
  stamina_init: 0
  gold: 0
  equip: ['sword', 'leather armor']
  consumables: []
  meals: 10
  player_name: 'Bob The Bold'

init: |
  fight_msg = ""
  function fight(name, enemy_skill, enemy_stamina)
    local player_attack = d(6) + d(6) + skill
    local enemy_attack = d(6) + d(6) + enemy_skill
    fight_msg = "Your attack roll: "..player_attack.."\nThe "..name.." rolls: "..enemy_attack.."\n\n"

    if player_attack > enemy_attack then
      enemy_stamina = math.max(0, enemy_stamina - 2)
      fight_msg = fight_msg.."You hit the "..name.." for 2 damage!"
    elseif enemy_attack > player_attack then
      stamina = stamina - 2
      fight_msg = fight_msg.."The "..name.." hits you for 2 damage!"
    else
      fight_msg = fight_msg.."It's a tie! No damage dealt."
    end

    if enemy_stamina <= 0 then
      fight_msg = "\nThe "..name.." is defeated!"
    end

    return enemy_stamina
  end

  function test_luck()
    local luck_roll = d(6) + d(6)
    local was_lucky = luck_roll <= luck
    luck_msg = "Your luck is "..luck.."\nYou rolled a "..luck_roll.."\n"
    luck = math.max(0, luck - 1)
    return was_lucky
  end

  function post_option()
    if stamina <= 0 then
      return "dead"
    end

    return nil
  end

  function inc_skill(amount)
    skill = math.min(skill_init, skill + amount)
  end
  function inc_stamina(amount)
    stamina = math.min(stamina_init, stamina + amount)
  end
  function inc_luck(amount)
    luck = math.min(luck_init, luck + amount)
  end

events:
  use_item: |
    if data.item_id == "healing potion (2 uses)" then
      stamina = stamina + 4
      remove(consumables, "healing potion (2 uses)")
      insert(consumables, "healing potion (1 use)")
      return "You sip at the healing potion and recover 4 stamina."
    elseif data.item_id == "healing potion (1 use)" then
      stamina = stamina + 4
      remove(consumables, "healing potion (1 use)")
      return "You drink the last of the healing potion and recover 4 stamina."
    end

    return "You can't use that item right now."

templates:
  - &fight
    text: 'Attack the {s.name}'
    if: s.stamina > 0
    run: |
      s.luck_used = false
      s.stamina = fight(s.name, s.skill, s.stamina)
    goto: self

  - &push_luck_damage
    text: 'Try to drive the attack: ðŸŽ² LUCK'
    if: s.stamina > 0 and luck > 0 and string.find(fight_msg, "You hit") ~= nil and not s.luck_used
    run: |
      luck_msg = ""
      if test_luck() then
        s.stamina = math.max(0, s.stamina - 2)
        luck_msg = luck_msg .. " You deal an extra 2 points of damage."
      else
        s.stamina = s.stamina + 1
        luck_msg = luck_msg .. " You were unlucky! The enemy takes 1 less damage."
      end
      if s.stamina <= 0 then
        fight_msg = "\nThe "..s.name.." is defeated!"
      end
      s.luck_used = true;
    notify: '{luck_msg}'
    goto: self

  - &push_luck_avoid
    text: 'Attempt to lessen the blow: ðŸŽ² LUCK'
    if: luck > 0 and string.find(fight_msg, "hits you") ~= nil and not s.luck_used
    run: |
      luck_msg = ""
      if test_luck() then
        stamina = stamina + 1
        luck_msg = luck_msg .. " You were lucky! You avoid 1 points of damage."
      else
        stamina = math.max(0, stamina - 1)
        luck_msg = luck_msg .. " You were unlucky! You take an extra 1 point of damage."
      end
      s.luck_used = true;
    notify: '{luck_msg}'
    goto: self

  - &test_luck
    run: s.lucky = test_luck()
    flags: [once]
    notify: '{luck_msg}'
    goto: self

  - &luck_pass
    if: s.lucky
    flags: [later]

  - &luck_fail
    if: not s.lucky
    flags: [later]

  - &eat_meal
    text: 'Rest and eat a meal'
    if: meals > 0
    run: |
      meals = meals - 1
      stamina = math.min(12, stamina + 4)
    notify: 'You eat a meal and restore 4 stamina, you have {meals} provisions left.'
    goto: self

sections:
  start:
    text: |
      Before embarking on your adventure, you must first determine your own strengths and weaknesses. To see how effective your preparations have been, you must use the dice to determine your initial scores for SKILL, STAMINA and LUCK.
      - Roll one six-sided die (ðŸŽ²) to determine your SKILL
      - Then roll two six-sided dice (ðŸŽ²ðŸŽ²) and add 12 to determine your STAMINA.
      - Finally, roll one six-sided dice (ðŸŽ²) and add 6 to determine your LUCK.
    options:
      roll_scores:
        text: 'Roll/re-roll scores: ðŸŽ² ðŸŽ² ðŸŽ²'
        run: |
          skill = d(6) + 6
          stamina = d(6) + d(6) + 12
          luck = d(6) + 6
          skill_init = skill
          stamina_init = stamina
          luck_init = luck
          s.rolled = true
          luck =2
        notify: "Your Skill is {skill}\nYour Stamina is {stamina}\nAnd your Luck is {luck}."
      begin:
        text: 'Proceed: Select your starting potion'
        if: s.rolled
        goto: pick_potion

  pick_potion:
    text: >
      You may take one bottle of a magical potion which will aid you on your quest. You may choose to take a bottle of any of the following potions:
    options:
      skill_potion:
        text: 'Potion of Skill'
        run: insert(consumables, "potion of skill (2 uses)")
        goto: start_adventure
      stamina_potion:
        text: 'Potion of Strength'
        run: insert(consumables, "potion of strength (2 uses)")
        goto: start_adventure
      luck_potion:
        text: 'Potion of Luck'
        run: insert(consumables, "potion of luck (2 uses)")
        goto: start_adventure

  start_adventure:
    text: >
      At last your two-day hike is over. You unsheathe your sword, lay it on the ground and sigh with relief as you lower yourself down on to the mossy rocks to sit for a moment's rest. You stretch, rub your eyes and finally look up at Firetop Mountain.

      The very mountain itself looks menacing. The steep face in front of you looks to have been savaged by the claws of some gargantuan beast. Sharp rocky crags jut out at unnatural angles. At the top of the mountain you can see the eerie red colouring - probably some strange vegetation -which has given the mountain its name. Perhaps no one will ever know exactly what grows up there, as climbing the peak must surely be impossible.

      Your quest lies ahead of you. Across the clearing is a dark cave entrance. You pick up your sword, get to your feet and consider what dangers may lie ahead of you. But with determination, you thrust the sword home into its scabbard and approach the cave.


      You peer into the gloom to see dark, slimy walls with pools of water on the stone floor in front of you. The air is cold and dank. You light your lantern and step warily into the blackness. Cobwebs brush your face and you hear the scurrying of tiny feet: rats, most likely. You set off into the cave. After a few yards you arrive at a junction
    options:
      west: ['Go west', s_71]
      east: ['Go east', s_278]

  s_71:
    text: There is a right-hand turn to the north in the passage. Cautiously you approach a sentry post on the corner and, as you look in, you can see a strange Goblin-like creature in leather armour asleep at his post.
    options:
      sneak:
        text: 'Try to sneak past: ðŸŽ² LUCK'
        run: s.sneak = test_luck()
        flags: [once]
        notify: '{luck_msg}'
        goto: self
      sneak_ok:
        text: 'He does not wake up and remains snoring loudly'
        if: s.sneak
        flags: [later]
        goto: s_301
      sneak_fail:
        text: 'You step with a crunch on some loose ground and his eyes flick open'
        if: not s.sneak
        flags: [later]
        goto: s_248

  s_301:
    text: |
      To your left, on the west face of the passage, there is a rough-cut wooden door. You listen at the door and can hear a rasping sound which may be some sort of creature snoring. Do you want to open the door?
    options:
      open_door: ['Open the door', s_82]
      press_on: ['Press on northwards', s_208]

  s_248:
    text: "The creature that has just awakened is an ORC! He scrambles to his feet and turns to grasp at a rope which is probably the alarm bell. You must attack him quickly.\n\nORC âŽ¯âŽ¯âŽ¯ Skill: {s.skill} Stamina: {s.stamina}\n\n{fight_msg}"
    vars: { stamina: 5, skill: 6, name: 'orc' }
    options:
      fight:
        <<: *fight
      push_luck_damage:
        <<: *push_luck_damage
      push_luck_avoid:
        <<: *push_luck_avoid
      after_battle:
        text: 'Press on northwards'
        if: s.stamina == 0
        goto: s_301

  s_82:
    text: |
      The door opens to reveal a small, smelly room. In the centre of the room is a rickety wooden table on which stands a lit candle. Underneath the table is a small wooden box. Asleep on a straw mattress in the far corner of the room is a short, stocky creature with an ugly, warty face; the same sort of creature that you found asleep at the sentry post. He must be the guard for the night watch.
    options:
      return:
        text: 'Return to the corridor and press on northwards'
        flags: [first]
        goto: s_208
      sneak:
        <<: *test_luck
        text: 'Try to sneak to the box without waking the guard: ðŸŽ² LUCK'
      sneak_ok:
        <<: *luck_pass
        text: 'You manage to grab box without waking the guard'
        goto: s_147
      sneak_fail:
        <<: *luck_fail
        text: 'As you reach for the box, the guard stirs and wakes up!'
        goto: s_33

  s_33:
    text: "The sleeping creature awakens startled. He jumps up and rushes at you, unarmed. With your sword you should be able to defeat him, but his sharp teeth look rather vicious!\n\nORC âŽ¯âŽ¯âŽ¯ Skill: {s.skill} Stamina: {s.stamina}\n\n{fight_msg}"
    vars: { stamina: 4, skill: 6, name: 'orc' }
    options:
      fight:
        <<: *fight
      push_luck_damage:
        <<: *push_luck_damage
      push_luck_avoid:
        <<: *push_luck_avoid
      after_battle:
        text: 'Take the box and leave the room'
        if: s.stamina == 0
        goto: s_147

  s_147:
    text: |
      You leave the room and open the box in the passage. Inside you find a single Piece of Gold and a small mouse, which must have been the creature's pet. You keep the coin and release the mouse, which scurries off down the passage.
      You gain 2 LUCK points.
    run: gold = gold + 1; inc_luck(2)
    options:
      press_on: ['Press on northwards', s_208]

  s_208:
    text: Further up the passage along the west wall you see another door. You listen at it but hear nothing
    options:
      open_door: ['Open the door', s_397]
      continue_north: ['Continue northwards', s_363]

  s_397:
    text: The door opens to reveal a small room with a stone floor and dirty walls. There is a stale smell in the air. In the centre of the room is a makeshift wooden table on which is standing a lit candle. Under the table is a small box. In the far corner of the room is a straw mattress
    options:
      open_box: ['Open the box', s_240]
      leave_room: ['Leave the room', s_363]

  s_240:
    text: "The box is light, but something rattles within. You open the lid and a small SNAKE darts out to bite at your wrist! You must fight the Snake\n\nSNAKE âŽ¯âŽ¯âŽ¯ Skill: {s.skill} Stamina: {s.stamina}\n\n{fight_msg}"
    vars: { stamina: 3, skill: 5, name: 'snake' }
    options:
      fight:
        <<: *fight
      push_luck_damage:
        <<: *push_luck_damage
      push_luck_avoid:
        <<: *push_luck_avoid
      after_battle:
        text: 'You have defeated the snake'
        if: s.stamina == 0
        goto: s_363

  s_363:
    text: Further up the passage on the west wall you see another similar door. You listen at the door and grimace to hear the worst singing you have ever heard in your life
    options:
      investigate:
        text: 'Investigate this hideous din'
        goto: s_370
      press_on:
        text: 'Carry on along the passage'
        goto: s_42

  dead:
    text: 'Your strength has failed you and you have died in the dungeons of Firetop Mountain. Your adventure ends here.'
    options:
      restart:
        text: 'Start a new adventure'
        goto: restart
